{% extends 'partials/base.html' %}
{% block title %}Add Stock Transaction{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Add Stock Transaction</h2>
    <form method="post" id="stock-transaction-form">
        {% csrf_token %}

        <!-- Transaction Type -->
        <div class="form-group d-flex align-items-center">
            <label for="id_transaction_type" class="mr-3">Transaction Type:</label>
            <button type="button" id="btn-add-stock" class="btn btn-success mr-2" onclick="toggleTransactionType('ADD')">Want to Add</button>
            <button type="button" id="btn-remove-stock" class="btn btn-danger" onclick="toggleTransactionType('REMOVE')">Want to Remove</button>
            <input type="hidden" id="id_transaction_type" name="transaction_type">
        </div>

        <!-- Product Selection -->
        <div class="form-group">
            <label for="id_product">Product</label>
            {{ form.product }}
        </div>

        <!-- Quantity -->
        <div class="form-group">
            <label for="id_quantity">Quantity</label>
            <div class="d-flex align-items-center">
                <input type="number" id="id_quantity" name="quantity" class="form-control mr-3" style="width: 120px;" min="1" placeholder="Enter quantity">
                <input type="text" id="available-stock" class="form-control bg-light text-dark" style="width: 150px;" readonly placeholder="Available: --">
            </div>
        </div>

        <!-- Remarks -->
        <div class="form-group">
            <label for="id_remarks">Remarks</label>
            {{ form.remarks }}
        </div>

        <!-- Buttons -->
        <button type="submit" class="btn btn-primary" id="btn-save">Save</button>
        <a href="{% url 'dashboard-stock-transactions' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    let selectedTransactionType = null;

    function toggleTransactionType(type) {
        selectedTransactionType = type;
        document.getElementById("id_transaction_type").value = type;

        if (type === "ADD") {
            document.getElementById("btn-add-stock").classList.add("active");
            document.getElementById("btn-remove-stock").classList.remove("active");
        } else {
            document.getElementById("btn-remove-stock").classList.add("active");
            document.getElementById("btn-add-stock").classList.remove("active");
        }
    }

    // Fetch stock level dynamically when a product is selected
    document.getElementById("id_product").addEventListener("change", function () {
        const productId = this.value;

        fetch(`/get-stock-level/${productId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.stock_level !== undefined) {
                    document.getElementById("available-stock").value = `Available: ${data.stock_level}`;
                } else {
                    document.getElementById("available-stock").value = "Available: --";
                }
            })
            .catch(error => console.error("Error fetching stock level:", error));
    });

    // Validate the form before submission
    document.getElementById("stock-transaction-form").addEventListener("submit", function (e) {
        const transactionType = document.getElementById("id_transaction_type").value;
        const product = document.getElementById("id_product").value;
        const quantity = document.getElementById("id_quantity").value;

        // Check if transaction type is selected
        if (!transactionType) {
            alert("Please select a transaction type (Add or Remove).");
            e.preventDefault();
            return;
        }

        // Check if product is selected
        if (!product) {
            alert("Please select a product.");
            e.preventDefault();
            return;
        }

        // Check if quantity is valid
        if (!quantity || parseInt(quantity) <= 0) {
            alert("Please enter a valid quantity greater than 0.");
            e.preventDefault();
            return;
        }

        // If removing stock, ensure quantity is less than or equal to available stock
        if (transactionType === "REMOVE") {
            const availableStock = parseInt(document.getElementById("available-stock").value.replace("Available: ", ""));
            if (parseInt(quantity) > availableStock) {
                alert(`Cannot remove ${quantity} units. Only ${availableStock} units are available.`);
                e.preventDefault();
                return;
            }
        }
    });
</script>
{% endblock %}
